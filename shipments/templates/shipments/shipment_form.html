{% extends 'base.html' %}
{% load static %}
{% load widget_tweaks %}

{% block title %}Create Shipment{% endblock title %}

{% block extra_css %}
<style>
    .form-section {
        background: #fff;
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        margin-bottom: 20px;
    }
    .form-section h3 {
        color: #2c3e50;
        margin-bottom: 20px;
        padding-bottom: 10px;
        border-bottom: 2px solid #eee;
    }
    .required-field::after {
        content: " *";
        color: red;
    }
    .card-header {
        cursor: pointer;
    }
    .card-header:hover {
        background-color: #0056b3 !important;
    }
    .form-control {
        margin-bottom: 0.5rem;
    }
    .form-label {
        margin-bottom: 0.25rem;
        font-weight: 500;
    }
    .collapse:not(.show) {
        display: none;
    }
</style>
{% endblock extra_css %}

{% block content %}
<div class="container mt-4">
    <h2 class="mb-4">Create New Shipment</h2>
    
    <form method="post" enctype="multipart/form-data" id="shipmentForm" class="needs-validation" novalidate>
        {% csrf_token %}
        
        <!-- Location Information -->
        <div class="card mb-3">
            <div class="card-header bg-primary text-white" data-bs-toggle="collapse" data-bs-target="#locationSection">
                <h5 class="mb-0">Location Information</h5>
            </div>
            <div id="locationSection" class="collapse show">
                <div class="card-body">
                    <div class="row">
                        <!-- Shipper Location -->
                        <div class="col-md-6">
                            <h6 class="border-bottom pb-2">Shipper Location</h6>
                            <div class="mb-3">
                                <label for="id_shipper_country" class="form-label required-field">Country</label>
                                {{ shipper_form.shipper_country|add_class:"form-select" }}
                                {% if shipper_form.shipper_country.errors %}
                                    <div class="text-danger">{{ shipper_form.shipper_country.errors.0 }}</div>
                                {% endif %}
                            </div>
                            <div class="mb-3">
                                <label for="id_shipper_city" class="form-label required-field">City</label>
                                {{ shipper_form.shipper_city|add_class:"form-select" }}
                                {% if shipper_form.shipper_city.errors %}
                                    <div class="text-danger">{{ shipper_form.shipper_city.errors.0 }}</div>
                                {% endif %}
                            </div>
                        </div>
                        <!-- Receiver Location -->
                        <div class="col-md-6">
                            <h6 class="border-bottom pb-2">Receiver Location</h6>
                            <div class="mb-3">
                                <label for="id_receiver_country" class="form-label required-field">Country</label>
                                {{ form.receiver_country|add_class:"form-select" }}
                                {% if form.receiver_country.errors %}
                                    <div class="text-danger">{{ form.receiver_country.errors.0 }}</div>
                                {% endif %}
                            </div>
                            <div class="mb-3">
                                <label for="id_receiver_city" class="form-label required-field">City</label>
                                {{ form.receiver_city|add_class:"form-select" }}
                                {% if form.receiver_city.errors %}
                                    <div class="text-danger">{{ form.receiver_city.errors.0 }}</div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Shipper Information -->
        <div class="card mb-3">
            <div class="card-header bg-primary text-white" data-bs-toggle="collapse" data-bs-target="#shipperSection">
                <h5 class="mb-0">Shipper Information</h5>
            </div>
            <div id="shipperSection" class="collapse">
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="id_shipper_name" class="form-label required-field">Name</label>
                                {{ shipper_form.shipper_name|add_class:"form-control" }}
                                {% if shipper_form.shipper_name.errors %}
                                    <div class="text-danger">{{ shipper_form.shipper_name.errors.0 }}</div>
                                {% endif %}
                            </div>
                            <div class="mb-3">
                                <label for="id_address" class="form-label required-field">Address</label>
                                {{ shipper_form.address|add_class:"form-control" }}
                                {% if shipper_form.address.errors %}
                                    <div class="text-danger">{{ shipper_form.address.errors.0 }}</div>
                                {% endif %}
                            </div>
                            <div class="mb-3">
                                <label for="id_zip_code" class="form-label">Zip Code</label>
                                {{ shipper_form.zip_code|add_class:"form-control" }}
                                {% if shipper_form.zip_code.errors %}
                                    <div class="text-danger">{{ shipper_form.zip_code.errors.0 }}</div>
                                {% endif %}
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="id_location" class="form-label">Location</label>
                                {{ shipper_form.location|add_class:"form-control" }}
                                {% if shipper_form.location.errors %}
                                    <div class="text-danger">{{ shipper_form.location.errors.0 }}</div>
                                {% endif %}
                            </div>
                            <div class="mb-3">
                                <label for="id_contact_person" class="form-label required-field">Contact Person</label>
                                {{ shipper_form.contact_person|add_class:"form-control" }}
                                {% if shipper_form.contact_person.errors %}
                                    <div class="text-danger">{{ shipper_form.contact_person.errors.0 }}</div>
                                {% endif %}
                            </div>
                            <div class="mb-3">
                                <label for="id_contact_number" class="form-label required-field">Contact Number</label>
                                {{ shipper_form.contact_number|add_class:"form-control" }}
                                {% if shipper_form.contact_number.errors %}
                                    <div class="text-danger">{{ shipper_form.contact_number.errors.0 }}</div>
                                {% endif %}
                            </div>
                            <div class="mb-3">
                                <label for="id_mobile_number" class="form-label">Mobile Number</label>
                                {{ shipper_form.mobile_number|add_class:"form-control" }}
                                {% if shipper_form.mobile_number.errors %}
                                    <div class="text-danger">{{ shipper_form.mobile_number.errors.0 }}</div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Receiver Information -->
        <div class="card mb-3">
            <div class="card-header bg-primary text-white" data-bs-toggle="collapse" data-bs-target="#receiverSection">
                <h5 class="mb-0">Receiver Information</h5>
            </div>
            <div id="receiverSection" class="collapse">
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="id_receiver_name" class="form-label required-field">Name</label>
                                {{ form.receiver_name|add_class:"form-control" }}
                                {% if form.receiver_name.errors %}
                                    <div class="text-danger">{{ form.receiver_name.errors.0 }}</div>
                                {% endif %}
                            </div>
                            <div class="mb-3">
                                <label for="id_receiver_address" class="form-label required-field">Address</label>
                                {{ form.receiver_address|add_class:"form-control" }}
                                {% if form.receiver_address.errors %}
                                    <div class="text-danger">{{ form.receiver_address.errors.0 }}</div>
                                {% endif %}
                            </div>
                            <div class="mb-3">
                                <label for="id_receiver_zip_code" class="form-label">Zip Code</label>
                                {{ form.receiver_zip_code|add_class:"form-control" }}
                                {% if form.receiver_zip_code.errors %}
                                    <div class="text-danger">{{ form.receiver_zip_code.errors.0 }}</div>
                                {% endif %}
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="id_receiver_location" class="form-label">Location</label>
                                {{ form.receiver_location|add_class:"form-control" }}
                                {% if form.receiver_location.errors %}
                                    <div class="text-danger">{{ form.receiver_location.errors.0 }}</div>
                                {% endif %}
                            </div>
                            <div class="mb-3">
                                <label for="id_receiver_contact_person" class="form-label required-field">Contact Person</label>
                                {{ form.receiver_contact_person|add_class:"form-control" }}
                                {% if form.receiver_contact_person.errors %}
                                    <div class="text-danger">{{ form.receiver_contact_person.errors.0 }}</div>
                                {% endif %}
                            </div>
                            <div class="mb-3">
                                <label for="id_receiver_contact_number" class="form-label required-field">Contact Number</label>
                                {{ form.receiver_contact_number|add_class:"form-control" }}
                                {% if form.receiver_contact_number.errors %}
                                    <div class="text-danger">{{ form.receiver_contact_number.errors.0 }}</div>
                                {% endif %}
                            </div>
                            <div class="mb-3">
                                <label for="id_receiver_mobile_number" class="form-label">Mobile Number</label>
                                {{ form.receiver_mobile_number|add_class:"form-control" }}
                                {% if form.receiver_mobile_number.errors %}
                                    <div class="text-danger">{{ form.receiver_mobile_number.errors.0 }}</div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Shipment Details -->
        <div class="card mb-3">
            <div class="card-header bg-primary text-white" data-bs-toggle="collapse" data-bs-target="#shipmentSection">
                <h5 class="mb-0">Shipment Details</h5>
            </div>
            <div id="shipmentSection" class="collapse">
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="id_product_type" class="form-label required-field">Product Type</label>
                                {{ form.product_type|add_class:"form-select" }}
                                {% if form.product_type.errors %}
                                    <div class="text-danger">{{ form.product_type.errors.0 }}</div>
                                {% endif %}
                            </div>
                            <div class="mb-3">
                                <label for="id_service" class="form-label required-field">Service</label>
                                {{ form.service|add_class:"form-select" }}
                                {% if form.service.errors %}
                                    <div class="text-danger">{{ form.service.errors.0 }}</div>
                                {% endif %}
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="id_quantity" class="form-label required-field">Quantity</label>
                                {{ form.quantity|add_class:"form-control" }}
                                {% if form.quantity.errors %}
                                    <div class="text-danger">{{ form.quantity.errors.0 }}</div>
                                {% endif %}
                            </div>
                            <div class="mb-3">
                                <label for="id_grossweight" class="form-label required-field">Gross Weight</label>
                                {{ form.grossweight|add_class:"form-control" }}
                                {% if form.grossweight.errors %}
                                    <div class="text-danger">{{ form.grossweight.errors.0 }}</div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Package Dimensions -->
        <div class="card mb-3">
            <div class="card-header bg-primary text-white" data-bs-toggle="collapse" data-bs-target="#dimensionsSection">
                <h5 class="mb-0">Package Dimensions</h5>
            </div>
            <div id="dimensionsSection" class="collapse">
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label for="id_length" class="form-label required-field">Length</label>
                                {{ form.length|add_class:"form-control" }}
                                {% if form.length.errors %}
                                    <div class="text-danger">{{ form.length.errors.0 }}</div>
                                {% endif %}
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label for="id_width" class="form-label required-field">Width</label>
                                {{ form.width|add_class:"form-control" }}
                                {% if form.width.errors %}
                                    <div class="text-danger">{{ form.width.errors.0 }}</div>
                                {% endif %}
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label for="id_height" class="form-label required-field">Height</label>
                                {{ form.height|add_class:"form-control" }}
                                {% if form.height.errors %}
                                    <div class="text-danger">{{ form.height.errors.0 }}</div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Payment Information -->
        <div class="card mb-3">
            <div class="card-header bg-primary text-white" data-bs-toggle="collapse" data-bs-target="#paymentSection">
                <h5 class="mb-0">Payment Information</h5>
            </div>
            <div id="paymentSection" class="collapse">
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label for="id_price_of_shipment" class="form-label required-field">Price</label>
                                {{ form.price_of_shipment|add_class:"form-control" }}
                                {% if form.price_of_shipment.errors %}
                                    <div class="text-danger">{{ form.price_of_shipment.errors.0 }}</div>
                                {% endif %}
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label for="id_cod_amount" class="form-label">COD Amount</label>
                                {{ form.cod_amount|add_class:"form-control" }}
                                {% if form.cod_amount.errors %}
                                    <div class="text-danger">{{ form.cod_amount.errors.0 }}</div>
                                {% endif %}
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label for="id_base_price" class="form-label required-field">Base Price</label>
                                {{ form.base_price|add_class:"form-control" }}
                                {% if form.base_price.errors %}
                                    <div class="text-danger">{{ form.base_price.errors.0 }}</div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Additional Information -->
        <div class="card mb-3">
            <div class="card-header bg-primary text-white" data-bs-toggle="collapse" data-bs-target="#additionalSection">
                <h5 class="mb-0">Additional Information</h5>
            </div>
            <div id="additionalSection" class="collapse">
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="id_item_description" class="form-label required-field">Item Description</label>
                                {{ form.item_description|add_class:"form-control" }}
                                {% if form.item_description.errors %}
                                    <div class="text-danger">{{ form.item_description.errors.0 }}</div>
                                {% endif %}
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="id_special_instruction" class="form-label">Special Instructions</label>
                                {{ form.special_instruction|add_class:"form-control" }}
                                {% if form.special_instruction.errors %}
                                    <div class="text-danger">{{ form.special_instruction.errors.0 }}</div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Identity Document -->
        <div class="card mb-3">
            <div class="card-header bg-primary text-white" data-bs-toggle="collapse" data-bs-target="#identitySection">
                <h5 class="mb-0">Identity Document</h5>
            </div>
            <div id="identitySection" class="collapse">
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-12">
                            <div class="mb-3">
                                <label for="id_identity_image" class="form-label required-field">Upload ID/Passport</label>
                                {{ form.identity_image|add_class:"form-control" }}
                                {% if form.identity_image.errors %}
                                    <div class="text-danger">{{ form.identity_image.errors.0 }}</div>
                                {% endif %}
                                <small class="form-text text-muted">Please upload a clear copy of your ID or passport</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="d-grid gap-2 d-md-flex justify-content-md-end">
            <button type="submit" class="btn btn-primary">Create Shipment</button>
        </div>
    </form>
</div>
{% endblock content %}

{% block extra_js %}
<script>
$(document).ready(function() {
    // Handle country-city selection
    function handleCountryChange(countryId, cityId) {
        const citySelect = $(cityId);
        citySelect.html('<option value="">---------</option>');
        
        if (countryId) {
            $.ajax({
                url: "{% url 'load_cities' %}",
                data: {
                    'country_id': countryId
                },
                dataType: 'json',
                success: function(data) {
                    data.forEach(function(city) {
                        citySelect.append(
                            $('<option></option>').val(city.id).html(city.name)
                        );
                    });
                }
            });
        }
    }

    // Shipper country change
    $('#id_shipper_country').change(function() {
        handleCountryChange($(this).val(), '#id_shipper_city');
    });

    // Receiver country change
    $('#id_receiver_country').change(function() {
        handleCountryChange($(this).val(), '#id_receiver_city');
    });

    // Form validation
    $('#shipmentForm').on('submit', function(event) {
        if (!this.checkValidity()) {
            event.preventDefault();
            event.stopPropagation();
        }
        $(this).addClass('was-validated');
    });
});
</script>
{% endblock extra_js %}